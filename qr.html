<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>QR Generator - IRIA Stalls</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      margin: 10px 0;
    }
    #qr {
      margin-top: 20px;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .out {
      margin-top: 20px;
      padding: 10px;
      background: #f3f3f3;
      word-break: break-all;
    }
  </style>
</head>

<body>
  <h2>IRIA Stall QR Generator</h2>

  <label>Stall Number:</label>
  <input id="stall" type="number" min="1" placeholder="Enter stall number">

  <label>Expiry (minutes from now):</label>
  <input id="mins" type="number" value="1440">

  <button onclick="makeQR()">Generate QR Code</button>

  <div class="out" id="result"></div>
  <div id="qr"></div>

  <!-- QR Code Library -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
    const BACKEND = "https://cmc-iria-secure.onrender.com";
    const FRONTEND = "https://cmcvellore-iria.github.io/stall-grid";

    async function makeQR() {
      const stall = document.getElementById("stall").value;
      const mins = document.getElementById("mins").value;

      if (!stall) return alert("Enter stall number");

      // 1) Request signed token from backend
      const resp = await fetch(`${BACKEND}/make-token`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stall, expMins: mins })
      });

      const data = await resp.json();
      if (!data.ok) {
        document.getElementById("result").innerText = `Error: ${data.error}`;
        return;
      }

      // 2) backend returns token + exp timestamp
      const url = `${FRONTEND}/?stall=${stall}&exp=${data.exp}&token=${data.token}`;

      // 3) Show signed URL text
      document.getElementById("result").innerHTML = `<b>Signed URL:</b><br>${url}`;

      // 4) Generate QR
      document.getElementById("qr").innerHTML = "";
      new QRCode(document.getElementById("qr"), {
        text: url,
        width: 256,
        height: 256
      });
    }
  </script>

</body>
</html>
