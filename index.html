<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CMC Stall Grid Passport – IRIA 2025</title>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
/* ---------------- RESET ---------------- */
* { box-sizing:border-box; margin:0; padding:0; }
html,body { height:100%; }

body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background:#020617;
  color:#f8fafc;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}

/* ---------------- HERO BACKGROUND ---------------- */
.hero-bg {
  position:fixed;
  inset:0;
  background:url("assets/chapel-hero.jpg") center/cover no-repeat;
  filter:brightness(1.1);
  z-index:-3;
  background-attachment:fixed;
}

.hero-overlay {
  position:fixed;
  inset:0;
  background:linear-gradient(to bottom, rgba(0,0,0,.04), rgba(0,0,0,.18));
  z-index:-2;
}

/* ---------------- TOP BAR ---------------- */
.top-bar {
  position:fixed; top:0; left:0; right:0;
  height:108px;
  display:flex; justify-content:space-between; align-items:center;
  padding:14px 20px;
  z-index:30;
}

.logo img { height:70px; transform:scale(1.12); }

/* ---------------- HERO TITLE ---------------- */
.hero-title {
  position:fixed;
  top:72px;
  left:50%;
  transform:translateX(-50%);
  text-align:center;
  transition:opacity .6s ease, transform .6s ease;
  z-index:25;
}

.hero-title .main {
  font-weight:700;
  font-size:1.42rem;
  color:#0b2338;
}

.hero-title .sub {
  margin-top:6px;
  font-size:0.95rem;
  color:#0b2338;
  opacity:0.95;
}

/* ---------------- FROSTED GLASS BOXES ---------------- */
.glass-zone {
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:20px;
  padding-top:60vh;
  padding-bottom:6vh;
}

.glass {
  width:min(1100px,94%);
  background:rgba(255,255,255,0.2);
  border-radius:14px;
  padding:24px 28px;
  backdrop-filter:blur(10px) saturate(120%);
  border:1px solid rgba(255,255,255,0.22);
  box-shadow:0 12px 38px rgba(0,0,0,.45);
  color:#031026;
  opacity:0;
  transform:translateY(28px);
  transition:opacity .9s cubic-bezier(.2,.9,.2,1),
             transform .9s cubic-bezier(.2,.9,.2,1);
}

.glass.revealed {
  opacity:1;
  transform:translateY(0);
}

.verse {
  font-family:"Times New Roman",serif;
  font-style:italic;
  font-size:1.05rem;
  color:rgba(5,25,30,.92);
  text-align:center;
  line-height:1.55;
}

.verse-ref {
  display:block;
  margin-top:8px;
  font-size:0.9rem;
  opacity:0.9;
}

.ida-title {
  font-family:"Times New Roman",serif;
  font-weight:600;
  font-size:1.02rem;
  text-align:center;
  color:#031026;
}

.ida-preview {
  font-family:"Times New Roman",serif;
  text-align:center;
  font-size:0.98rem;
  color:rgba(3,16,34,.92);
  margin-top:4px;
}

.hero-actions {
  margin-top:10px;
  display:flex;
  justify-content:center;
  gap:12px;
}

.link-btn {
  padding:10px 16px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.6);
  background:rgba(9,14,21,.26);
  color:#f1f9ff;
  cursor:pointer;
  font-weight:600;
}

.scroll-hint {
  margin-left:12px;
  opacity:0.9;
  cursor:pointer;
  color:rgba(2,10,20,.75);
}

/* ---------------- PASSPORT SECTION ---------------- */
.passport {
  background:transparent;
  padding:48px 18px 80px;
}

.content-wrap {
  width:96%;
  max-width:1040px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:18px;
}

/* ---------------- AUTH + GRID CARDS ---------------- */
.auth-card, .grid-card {
  background:rgba(255,255,255,0.14);
  border-radius:14px;
  padding:20px;
  border:1px solid rgba(255,255,255,0.18);
  backdrop-filter:blur(9px);
  color:#eaf7ff;
  box-shadow:0 12px 36px rgba(0,0,0,.45);
}

/* ---------------- AUTH AREA FIXES ---------------- */
.auth-top {
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.pill {
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(9,14,21,.45);
  font-size:12px;
  letter-spacing:0.13em;
}

input {
  width:100%;
  padding:11px 12px;
  margin-top:10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(3,6,10,.48);
  color:#eef7ff;
  font-size:0.96rem;
}

.auth-buttons {
  display:flex;
  gap:10px;
  margin-top:14px;
}

.btn-register {
  background:#9ad3bc;
  color:#043024;
  padding:10px 14px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.btn-login {
  background:#8bbcea;
  color:#06253b;
  padding:10px 14px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.btn-ghost {
  background:transparent;
  border:1px solid rgba(255,255,255,.18);
  padding:8px 12px;
  border-radius:999px;
  color:#eaf7ff;
  cursor:pointer;
}

/* ---------------- STALL GRID FIXES (A) ---------------- */
.grid-container {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(120px,1fr));
  gap:14px;
  margin-top:14px;
}

.neon-stall {
  padding:14px 10px;
  border-radius:12px;
  background:radial-gradient(circle at top, #071025, #02101a 90%);
  border:1px solid rgba(34,211,238,0.55);
  color:#a8f6ff;
  font-weight:700;
  text-align:center;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  box-shadow:0 10px 24px rgba(10,40,60,.55);
  transition:transform .16s ease, box-shadow .16s ease;
}

.neon-stall:hover {
  transform:translateY(-4px);
  box-shadow:0 16px 32px rgba(10,40,60,.75);
}

.neon-stall.visited {
  border-color:rgba(74,222,128,.95);
  background:linear-gradient(180deg,#032a16,#011212);
  color:#dfffe6;
}

/* ---------------- LEADERBOARD ---------------- */
#leader-list {
  margin-top:10px;
  max-height:260px;
  overflow:auto;
  padding-right:6px;
  font-size:0.92rem;
}

#leader-list .row {
  display:flex;
  justify-content:space-between;
  padding:8px 6px;
  border-bottom:1px solid rgba(255,255,255,0.06);
}

/* ---------------- QR OVERLAY (B) ---------------- */
#qr-overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.92);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:200;
  padding:20px;
}

#qr-reader {
  width:90vw;
  max-width:420px;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 0 40px rgba(0,255,255,0.35);
}

/* ---------------- TOAST ---------------- */
#toast {
  position:fixed;
  left:50%; bottom:28px;
  transform:translateX(-50%) translateY(10px);
  background:#021021;
  color:#e9f9ff;
  padding:10px 16px;
  border-radius:999px;
  opacity:0;
  pointer-events:none;
  z-index:300;
  transition:opacity .25s, transform .25s;
}

#toast.show {
  opacity:1;
  transform:translateX(-50%) translateY(0);
}

/* ---------------- UTILS ---------------- */
.hidden { display:none !important; }

/* ---------------- MOBILE FIXES ---------------- */
@media(max-width:820px) {
  .logo img {height:56px;}
  .hero-title .main {font-size:1.28rem;}
  .hero-bg {background-position:center 20%;}
}

@media(max-width:420px) {
  .hero-title {top:60px;}
  .verse {font-size:0.96rem;}
}

/* Mobile full-height fix */
:root { --vh:1vh; }
.fix-h { height:calc(var(--vh) * 100); }
</style>
</head>
<body>

<!-- hero background layers -->
<div class="hero-bg" aria-hidden="true"></div>
<div class="hero-overlay" aria-hidden="true"></div>

<!-- fixed top logos -->
<div class="top-bar" role="banner">
  <div class="logo left">
    <img src="assets/iria2025.png" alt="IRIA">
  </div>
  <div class="logo right">
    <img src="assets/cmc.png" alt="CMC">
  </div>
</div>

<!-- fixed hero title -->
<div class="hero-title" aria-hidden="true">
  <div class="main">Welcome to the 78th Annual TNPY IRIA Conference</div>
  <div class="sub">at Christian Medical College, Vellore</div>
</div>

<!-- empty hero area (shows chapel background) -->
<main class="hero-wrap fix-h" id="hero">
  <div style="width:100%;height:1px"></div>
</main>

<!-- FROSTED GLASS BOXES -->
<section class="glass-zone" id="glass-zone">

  <!-- Glass 1 -->
  <div class="glass" id="verseGlass">
    <div class="verse">
      “Even as the Son of man came not to be ministered unto, but to minister,
      and to give his life a ransom for many.”
      <span class="verse-ref">Matthew 20:28</span>
    </div>
  </div>

  <!-- Glass 2 -->
  <div class="glass" id="idaGlass">
    <div class="ida-title">Aunt Ida’s Prayer</div>
    <div class="ida-preview">Father, whose life is within me, and whose love is ever about me…</div>

    <div class="hero-actions">
      <button class="link-btn" id="openPrayerBtn">Read full prayer</button>
      <div class="scroll-hint" id="scrollToPassport">Scroll to begin the Stall Grid Contest ↓</div>
    </div>
  </div>

</section>

<!-- PASSPORT (AUTH + GRID + LEADERBOARD) -->
<section id="passport" class="passport panel">
  <div class="content-wrap">

    <!-- AUTH CARD -->
    <div class="auth-card" id="auth-card">
      <div class="auth-top">
        <div>
          <div class="pill">Conference Access</div>
          <div style="font-size:1rem;font-weight:700;margin-top:6px">Sign in to access your Passport</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div id="auth-status">Not signed in</div>
          <div id="logout-wrap" class="hidden">
            <button class="btn-ghost" id="logoutBtn">Logout</button>
          </div>
        </div>
      </div>

      <!-- UPDATED INPUT LABELS -->
      <input id="name-input" placeholder="Full Name (as per registration)" autocomplete="name" />
      <input id="email-input" placeholder="Email Address" autocomplete="email" />
      <input id="delegate-input" placeholder="Registration ID (required)" autocomplete="off" />
      <input id="password-input" type="password" placeholder="Password" autocomplete="current-password"/>

      <div class="auth-buttons">
        <button class="btn-register" id="registerBtn">Register</button>
        <button class="btn-login" id="loginBtn">Login</button>
        <button class="btn-ghost" id="forgotBtn">Forgot?</button>
      </div>

      <!-- UPDATED NOTE (Option B) -->
      <p style="margin-top:12px;font-size:0.9rem;color:rgba(235,245,255,0.9)">
        Log in using the email and Registration ID from your official CMC IRIA 2025 registration.
        Verified delegates are eligible for leaderboard rankings and prizes.
      </p>
    </div>

    <!-- GRID CARD -->
    <div class="grid-card hidden" id="grid-card">

      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="pill">Stall Grid</div>
          <div style="font-size:0.98rem;font-weight:600;margin-top:6px;">
            Scan QR at Each Exhibitor
          </div>
          <p style="font-size:0.88rem;opacity:0.95;margin-top:6px;">
            Tap a stall tile to open the camera. After scanning, your visit will be recorded instantly.
          </p>
        </div>

        <div>
          <button class="btn-ghost" id="refreshLeaderboardBtn">Refresh</button>
        </div>
      </div>

      <!-- USER BANNER (SHOWS REG ID) -->
      <div id="user-banner" class="hidden" style="margin-top:12px;font-weight:700"></div>

      <!-- 35 stall grid -->
      <div id="grid" class="grid-container" aria-live="polite"></div>

      <!-- LEADERBOARD -->
      <div id="leaderboard" style="margin-top:20px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="pill">Leaderboard</div>
            <div style="font-size:0.95rem;font-weight:600;margin-top:6px;">
              Most Active Stall Explorers
            </div>
          </div>
        </div>

        <div id="leader-list"></div>
      </div>

    </div>

  </div>
</section>

<!-- QR SCAN OVERLAY -->
<div id="qr-overlay">
  <div id="qr-reader"></div>
  <button class="btn-ghost" id="qr-close" style="margin-top:14px;">Close</button>
</div>

<!-- PRAYER MODAL -->
<div id="prayer-modal" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.72);
  display:none; align-items:center; justify-content:center;
  z-index:220; padding:16px;
">
  <div style="
    background:#fff; color:#031026; padding:20px;
    border-radius:12px; max-width:720px; max-height:80vh; overflow:auto;
  ">
    <h3 style="font-family:'Times New Roman',serif;font-style:italic;">Aunt Ida’s Prayer</h3>

    <div style="font-family:'Times New Roman',serif;font-style:italic;line-height:1.5;">
      Father, whose life is within me, and whose love is ever about me...
      <p style="margin-top:8px">… (full prayer text here)</p>
    </div>

    <div style="text-align:right;margin-top:12px;">
      <button class="link-btn" id="closePrayerBtn">Close</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>
<script type="module">
/* ---------- MOBILE VH FIX ---------- */
function setRealVH() {
  document.documentElement.style.setProperty("--vh", window.innerHeight * 0.01 + "px");
}
setRealVH();
window.addEventListener("resize", setRealVH);
window.addEventListener("orientationchange", setRealVH);

/* ---------- CONFIG ---------- */
const API_BASE = "https://cmc-iria-secure.onrender.com";
const DEFAULT_STALL_COUNT = 35;

/* ---------- ELEMENTS ---------- */
const authCard = document.getElementById("auth-card");
const gridCard = document.getElementById("grid-card");
const gridEl = document.getElementById("grid");
const leaderListEl = document.getElementById("leader-list");
const userBanner = document.getElementById("user-banner");
const authStatus = document.getElementById("auth-status");
const logoutWrap = document.getElementById("logout-wrap");
const qrOverlay = document.getElementById("qr-overlay");
const qrReader = document.getElementById("qr-reader");
const toastEl = document.getElementById("toast");

/* Form Inputs */
const nameInput = document.getElementById("name-input");
const emailInput = document.getElementById("email-input");
const regIdInput = document.getElementById("delegate-input");
const passInput = document.getElementById("password-input");

/* Buttons */
const registerBtn = document.getElementById("registerBtn");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const forgotBtn = document.getElementById("forgotBtn");
const refreshLeaderboardBtn = document.getElementById("refreshLeaderboardBtn");
const openPrayerBtn = document.getElementById("openPrayerBtn");
const closePrayerBtn = document.getElementById("closePrayerBtn");
const scrollToPassport = document.getElementById("scrollToPassport");

/* ---------- STATE ---------- */
let jwtToken = localStorage.getItem("jwt") || null;
let delegateId = localStorage.getItem("delegateId") || null;
let regId = localStorage.getItem("regId") || null;
let currentName = localStorage.getItem("name") || null;

/* ---------- TOAST ---------- */
function showToast(msg) {
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(() => toastEl.classList.remove("show"), 2000);
}

/* ---------- API WRAPPER ---------- */
async function apiFetch(path, opts = {}) {
  const headers = opts.headers || {};
  headers["Content-Type"] = "application/json";
  if (jwtToken) headers["Authorization"] = "Bearer " + jwtToken;
  opts.headers = headers;

  const res = await fetch(API_BASE + path, opts);
  const raw = await res.text();
  let data;
  try {
    data = raw ? JSON.parse(raw) : {};
  } catch {
    data = raw;
  }

  if (!res.ok) throw data;
  return data;
}

/* ---------- UPDATE UI ---------- */
function updateUIForAuth() {
  if (jwtToken && delegateId) {
    authStatus.textContent = `Signed in as ${currentName}`;
    logoutWrap.classList.remove("hidden");
    authCard.classList.add("hidden");
    gridCard.classList.remove("hidden");

    userBanner.classList.remove("hidden");
    userBanner.textContent = `${currentName} — Reg ID: ${regId}`;
  } else {
    authStatus.textContent = "Not signed in";
    logoutWrap.classList.add("hidden");
    authCard.classList.remove("hidden");
    gridCard.classList.add("hidden");
    userBanner.classList.add("hidden");
  }
}

/* ---------- REGISTER ---------- */
registerBtn.addEventListener("click", async () => {
  const name = nameInput.value.trim();
  const email = emailInput.value.trim();
  const regIdVal = regIdInput.value.trim();
  const pass = passInput.value.trim();

  if (!email || !pass || !regIdVal) {
    alert("Email, Registration ID, and password are required.");
    return;
  }

  try {
    const payload = { name, email, password: pass, regId: regIdVal };
    const data = await apiFetch("/api/signup", {
      method: "POST",
      body: JSON.stringify(payload),
    });

    jwtToken = data.token;
    delegateId = data.delegateId;
    regId = regIdVal;
    currentName = data.name || name || email;

    localStorage.setItem("jwt", jwtToken);
    localStorage.setItem("delegateId", delegateId);
    localStorage.setItem("regId", regIdVal);
    localStorage.setItem("name", currentName);

    showToast("Registered & logged in!");
    updateUIForAuth();
    await loadUserVisitsAndLeaderboard();

    document.getElementById("passport").scrollIntoView({ behavior: "smooth" });
  } catch (e) {
    alert(e.error || e.message || "Registration failed.");
  }
});

/* ---------- LOGIN ---------- */
loginBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const pass = passInput.value.trim();

  if (!email || !pass) {
    alert("Enter email and password.");
    return;
  }

  try {
    const data = await apiFetch("/api/login", {
      method: "POST",
      body: JSON.stringify({ email, password: pass }),
    });

    jwtToken = data.token;
    delegateId = data.delegateId;
    currentName = data.name || email;

    localStorage.setItem("jwt", jwtToken);
    localStorage.setItem("delegateId", delegateId);
    localStorage.setItem("name", currentName);

    showToast("Logged in!");
    updateUIForAuth();
    await loadUserVisitsAndLeaderboard();

    document.getElementById("passport").scrollIntoView({ behavior: "smooth" });
  } catch (e) {
    alert(e.error || "Login failed.");
  }
});

/* ---------- LOGOUT ---------- */
logoutBtn.addEventListener("click", () => {
  jwtToken = null;
  delegateId = null;
  regId = null;
  currentName = null;

  localStorage.removeItem("jwt");
  localStorage.removeItem("delegateId");
  localStorage.removeItem("regId");
  localStorage.removeItem("name");

  showToast("Logged out.");
  updateUIForAuth();
  clearVisitedStalls();
  leaderListEl.innerHTML = "";
});

/* ---------- FORGOT PASSWORD ---------- */
forgotBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  if (!email) {
    alert("Enter your registered email.");
    return;
  }
  try {
    await apiFetch("/api/request-reset", {
      method: "POST",
      body: JSON.stringify({ email }),
    });
    alert("If registered, a reset OTP has been created.");
  } catch {
    alert("Reset not available.");
  }
});

/* ---------- BUILD STALL GRID ---------- */
function createStallCard(id) {
  const tile = document.createElement("div");
  tile.className = "neon-stall";
  tile.dataset.stallId = id;
  tile.innerHTML = `<div style="font-size:1rem">${id}</div><div style="font-size:0.8rem;opacity:0.85">Tap to scan</div>`;
  tile.addEventListener("click", () => openScanner(id));
  gridEl.appendChild(tile);
}

function buildGrid(count) {
  gridEl.innerHTML = "";
  for (let i = 1; i <= count; i++) {
    createStallCard(`Stall ${i}`);
  }
}

/* ---------- VISITS + LEADERBOARD ---------- */
async function loadUserVisitsAndLeaderboard() {
  if (jwtToken && delegateId) {
    try {
      const v = await apiFetch(`/api/visits/${delegateId}`, { method: "GET" });
      if (v.visits) {
        const visited = new Set(v.visits.map(String));
        document.querySelectorAll(".neon-stall").forEach((card) => {
          const num = card.dataset.stallId.replace("Stall ", "");
          if (visited.has(num)) {
            card.classList.add("visited");
            card.innerHTML = `<div style="font-size:1rem">${card.dataset.stallId} ✓</div>
                              <div style="font-size:0.8rem;opacity:0.85">Visited</div>`;
          }
        });
      }
    } catch {}
  }
  await loadLeaderboard();
}

async function loadLeaderboard() {
  leaderListEl.innerHTML = "<div style='padding:8px'>Loading…</div>";
  try {
    const data = await apiFetch("/api/leaderboard", { method: "GET" });
    const rows = data.top || [];

    if (!rows.length) {
      leaderListEl.innerHTML = "<div style='padding:8px;opacity:0.8'>No visits yet.</div>";
      return;
    }

    leaderListEl.innerHTML = "";
    rows.forEach((r, i) => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div style="font-weight:700">${i + 1}. ${r.name}</div>
        <div>${r.count} stalls</div>`;
      leaderListEl.appendChild(row);
    });
  } catch {
    leaderListEl.innerHTML = "<div style='padding:8px;color:#fdd'>Error loading leaderboard</div>";
  }
}

refreshLeaderboardBtn.addEventListener("click", () => {
  loadLeaderboard().then(() => showToast("Leaderboard refreshed"));
});

/* ---------- QR SCANNING ---------- */
let html5QrInstance = null;

async function openScanner(stallName) {
  if (!jwtToken) {
    alert("Please log in first.");
    return;
  }

  qrOverlay.style.display = "flex";

  try {
    if (!html5QrInstance) html5QrInstance = new Html5Qrcode("qr-reader");

    try {
      await html5QrInstance.stop();
    } catch {}

    await html5QrInstance.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: calcQRBox() },
      async (decoded) => {
        try { await html5QrInstance.stop(); } catch {}
        qrOverlay.style.display = "none";
        await processDecodedQR(stallName, decoded);
      }
    );
  } catch (err) {
    qrOverlay.style.display = "none";
    alert("Camera error: " + err);
  }
}

function calcQRBox() {
  return Math.floor(Math.min(window.innerWidth, 420) * 0.75);
}

document.getElementById("qr-close").addEventListener("click", async () => {
  qrOverlay.style.display = "none";
  try { await html5QrInstance.stop(); } catch {}
});

/* ---------- QR DECODING & HYBRID FLOW ---------- */
async function processDecodedQR(stallName, decoded) {
  let url = null;

  try {
    url = new URL(decoded);
  } catch {
    alert("Invalid QR");
    return;
  }

  const stall = url.searchParams.get("stall") || stallName;
  const exp = url.searchParams.get("exp");
  const token = url.searchParams.get("token");

  if (!stall) {
    alert("Invalid stall QR.");
    return;
  }

  // HYBRID FLOW: static QR → request token → auto verify
  if (!token || !exp) {
    try {
      const t = await apiFetch("/api/generate-visit-token", {
        method: "POST",
        body: JSON.stringify({ stall }),
      });

      const v = await apiFetch("/api/verify", {
        method: "POST",
        body: JSON.stringify({ stall, exp: t.exp, token: t.token }),
      });

      if (v.ok) {
        showToast(`Stall ${stall} recorded`);
        markVisited(stallName);
        await loadUserVisitsAndLeaderboard();
      }
    } catch (e) {
      alert("Verification failed.");
    }
    return;
  }
}

function markVisited(stall) {
  document.querySelectorAll(".neon-stall").forEach((card) => {
    if (card.dataset.stallId === stall || card.dataset.stallId.endsWith(stall)) {
      card.classList.add("visited");
      card.innerHTML = `<div style="font-size:1rem">${card.dataset.stallId} ✓</div>
                        <div style="font-size:0.8rem;opacity:0.85">Visited</div>`;
    }
  });
}

function clearVisitedStalls() {
  document.querySelectorAll(".neon-stall").forEach((card) => {
    card.classList.remove("visited");
    card.innerHTML = `<div style="font-size:1rem">${card.dataset.stallId}</div>
                      <div style="font-size:0.8rem;opacity:0.85">Tap to scan</div>`;
  });
}

/* ---------- PRAYER MODAL + SCROLL ---------- */
openPrayerBtn.addEventListener("click", () => {
  document.getElementById("prayer-modal").style.display = "flex";
});
closePrayerBtn.addEventListener("click", () => {
  document.getElementById("prayer-modal").style.display = "none";
});
scrollToPassport.addEventListener("click", () =>
  document.getElementById("passport").scrollIntoView({ behavior: "smooth" })
);

/* ---------- INIT ---------- */
(function init() {
  buildGrid(DEFAULT_STALL_COUNT);
  updateUIForAuth();

  if (jwtToken && delegateId) {
    loadUserVisitsAndLeaderboard();
    gridCard.classList.remove("hidden");
  } else {
    loadLeaderboard();
  }
})();
</script>

</body>
</html>
