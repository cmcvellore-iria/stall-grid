<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CMC Stall Grid Passport – IRIA 2025</title>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
 .hidden {
  display: none !important;
}

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:#020617;
    color:#f8fafc;
    overflow-x:hidden;
    -webkit-font-smoothing:antialiased;
  }

  /* HERO */
  .hero-bg{
    position:fixed; inset:0;
    background:url("assets/chapel-hero.jpg") center center/cover no-repeat;
    z-index:-3;
  }

  .top-bar{
    position:fixed; top:0; left:0; right:0;
    height:110px; padding:15px 22px;
    display:flex; justify-content:space-between; align-items:center;
    z-index:50;
    pointer-events:none;
  }
  .top-bar .logo{pointer-events:auto}
  .logo img{height:70px}

  /* HERO CENTER TITLE */
  .hero-title{
    position:fixed;
    top:80px; left:50%; transform:translateX(-50%);
    text-align:center;
    z-index:40;
    transition:opacity .5s ease, transform .5s ease;
  }
  .hero-title .main{
  font-size:1.6rem;
  font-weight:700;
  color:#000;
  text-shadow:none;
}

.hero-title .sub{
  margin-top:6px;
  font-size:1rem;
  color:#000;
  opacity:0.95;
}

  /* HERO CONTAINER */
  .hero-wrap{
    min-height:100vh;
    display:flex; align-items:center; justify-content:center;
  }

  /* GLASS ZONE */
  .glass-zone{
  margin-top:360px;
  padding-bottom:40px;
  display:flex;
  flex-direction:column;
  gap:24px;
  align-items:center;
}

  .glass{
    width:min(900px,92%);
    background:rgba(255,255,255,0.32);
    border-radius:18px;
    padding:28px;
    backdrop-filter:blur(16px) saturate(120%);
    border:1px solid rgba(255,255,255,0.35);
    opacity:0; transform:translateY(28px);
    transition:opacity .8s ease, transform .8s ease;
  }
  .glass.revealed{opacity:1; transform:translateY(0)}

  .verse{text-align:center;font-style:italic;font-size:1.05rem;color:#021d2a}
  .verse-ref{display:block;margin-top:8px;font-size:0.9rem;opacity:0.8}

  .ida-title{text-align:center;font-family:"Times New Roman",serif;font-size:1.1rem;margin-bottom:6px;color:#021d2a}
  .ida-preview{text-align:center;color:#02202f;font-family:"Times New Roman",serif;font-size:1rem}
 .ida-full{
  max-height:0;
  overflow:hidden;
  margin-top:14px;
  font-family:"Times New Roman", serif;
  font-style:italic;
  line-height:1.6;
  color:#021d2a;
  opacity:0;
  transition:
    max-height .9s ease,
    opacity .5s ease;
}

.ida-full.open{
  max-height:1400px; /* safely larger than full prayer */
  opacity:1;
}

  .hero-actions{margin-top:12px;display:flex;gap:14px;justify-content:center}
  .link-btn{
    padding:10px 18px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,0.6);
    background:rgba(255,255,255,0.15);
    color:#002131;
    font-weight:600;
    cursor:pointer;
    backdrop-filter:blur(6px);
  }
  .scroll-hint{cursor:pointer;font-size:0.95rem;opacity:0.8;color:#002131}

  /* AUTH + GRID */
  .passport{padding:50px 20px;margin-top:50px}
  .content-wrap{max-width:1050px;margin:0 auto;display:flex;flex-direction:column;gap:20px}

  .auth-card,.grid-card{
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(12px);
    padding:20px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.25);
  }

  .pill{
    display:inline-block;
    padding:5px 10px;
    border-radius:999px;
    background:rgba(9,14,21,0.45);
    letter-spacing:0.12em;
    font-size:12px;
  }

  input{
    width:100%; padding:12px;
    border-radius:12px;
    margin-top:10px;
    border:1px solid rgba(255,255,255,0.22);
    background:rgba(255,255,255,0.25);
    backdrop-filter:blur(8px);
    color:#002131;
    font-size:0.95rem;
  }

  .auth-buttons{display:flex;gap:12px;margin-top:14px}
  .btn-register{
    background:#b9f5df; color:#003826;
    padding:10px 16px; border-radius:999px; border:none; cursor:pointer;
  }
  .btn-login{
    background:#b3dffe; color:#002846;
    padding:10px 16px; border-radius:999px; border:none; cursor:pointer;
  }
  .btn-ghost{
    background:transparent;
    border:1px solid rgba(255,255,255,0.4);
    padding:9px 14px; border-radius:999px; cursor:pointer;
    color:#e8f8ff;
  }

  #grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(90px, 1fr));
  gap:16px;
}
  .neon-stall{
  padding:12px 8px;
  min-height:64px;
  border-radius:12px;
  font-size:0.9rem;
  font-weight:600;
  background: rgba(255,255,255,0.30);
  border:1px solid rgba(34,211,238,0.6);
  color:#d8fcff;
  text-align:center;
  cursor:pointer;
  backdrop-filter:blur(12px);
  transition:transform .15s, box-shadow .15s;
}
  .neon-stall:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(0,0,0,0.4)}
  .neon-stall.visited{
    background:rgba(0,60,32,0.3);
    border-color:#4ade80;
    color:#e9ffe9;
  }

  #toast{
    position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
    background:#002b44;color:#e8faff;
    padding:12px 20px;border-radius:999px;
    opacity:0;transition:opacity .25s;
  }
  #toast.show{opacity:1}
</style>
</head>

<body>

<div class="hero-bg"></div>

<!-- FIXED LOGOS + TITLE -->
<div class="top-bar">
  <div class="logo"><img src="assets/iria2025.png"></div>
  <div class="hero-title">
    <div class="main">Welcome to the Stall Grid Contest at CMC Vellore</div>
    <div class="sub">Explore every stall • Scan QR codes • Complete the stall grid &amp; win exciting prizes</div>
  </div>
  <div class="logo"><img src="assets/cmc.png"></div>
</div>

<main class="hero-wrap" id="hero">
  <section class="glass-zone" id="glass-zone">
    <div class="glass" id="verseGlass">
      <div class="verse">
        “Even as the Son of man came not to be ministered unto, but to minister…”
        <span class="verse-ref">Matthew 20:28</span>
      </div>
    </div>

    <div class="glass" id="idaGlass">
      <div class="ida-title">Aunt Ida’s Prayer</div>
      <div class="ida-preview">
        Father, whose life is within me, and whose love is ever about me…
      </div>
     <div class="ida-full" id="idaFull">
  Father, whose life is within me,<br>
  and whose love is ever about me,<br>
  grant that Thy life may be maintained in my life today and every day,<br>
  as with gladness of heart, without haste or confusion of thought,<br>
  I go about my daily tasks,<br>
  conscious of the ability to meet every rightful demand,<br>
  seeing the larger meaning of little things,<br>
  and finding beauty and love everywhere.<br><br>

  In the sense of Thy presence, may I walk through the hours,<br>
  breathing the atmosphere of love rather than anxious striving,<br>
  free from fear, resentment, impatience, or worry,<br>
  living today as Thy child,<br>
  conscious of Thy guidance and strength in all that I do.<br><br>

  May I be gentle and understanding with others,<br>
  patient in difficulties,<br>
  faithful in small things,<br>
  courageous in great ones,<br>
  and ever mindful that my life is not my own,<br>
  but Thine, to be lived in loving service.<br><br>

  And when the day is over,<br>
  grant that I may look back without regret,<br>
  knowing that I have tried to live this day<br>
  in harmony with Thy will.<br>
  Amen.
</div>
      <div class="hero-actions">
        <button class="link-btn" id="togglePrayerBtn">Read Full Prayer</button>
        <div class="scroll-hint" id="scrollToPassport">Scroll to Start ↓</div>
      </div>
    </div>
  </section>
</main>

<section id="passport" class="passport">
  <div class="content-wrap">

    <!-- UPDATED AUTH CARD -->
    <div class="auth-card" id="auth-card">
      <div class="pill">DELEGATE LOGIN</div>
      <h3 style="margin-top:10px;color:#e8faff;font-size:1.1rem;font-weight:700">
        Access Your Stall Grid Passport
      </h3>

      <input id="name-input" placeholder="Full Name (as per registration)">
      <input id="email-input" placeholder="Email (as per registration)">
      <input id="password-input" type="password" placeholder="Create / Enter Password">

      <div class="auth-buttons">
        <button class="btn-register" id="registerBtn">Create My Passport</button>
        <button class="btn-login" id="loginBtn">Login</button>
        <button class="btn-ghost" id="forgotBtn">Forgot?</button>
      </div>

      <p style="margin-top:12px;font-size:0.9rem;color:#e8faff">
        Use the same email you used for conference registration.
      </p>
    </div>
    <!-- GRID CARD -->
    <div class="grid-card hidden" id="grid-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="pill">STALL GRID</div>
          <div style="font-size:1rem;font-weight:600;margin-top:6px;">Scan QR at Each Exhibitor</div>
          <p style="font-size:0.9rem;opacity:0.9;margin-top:6px;">
            Tap a stall tile to open the camera. Your visit is recorded instantly.
          </p>
        </div>
       <div style="display:flex; gap:10px;">
  <button class="btn-ghost" id="refreshLeaderboardBtn">Refresh</button>
        <button class="btn-ghost hidden" id="downloadCsvBtn">Download CSV</button>
  <button class="btn-ghost" id="logoutBtn">Logout</button>
</div>

      </div>

      <div id="user-banner" class="hidden"
           style="margin-top:12px;font-weight:700;font-size:1rem;color:#e8faff"></div>

      <div id="grid" class="grid-container" style="margin-top:14px"></div>

      <div id="leaderboard" class="hidden" style="margin-top:22px">
        <div class="pill">LEADERBOARD</div>
        <div style="font-size:0.95rem;font-weight:600;margin-top:6px;">
          Most Active Stall Explorers
         <div style="font-size:0.8rem;opacity:0.75;margin-top:4px;">
  Winners subject to verification
</div>
        </div>
        <div id="leader-list" style="margin-top:10px"></div>
      </div>
    </div>

  </div>
</section>


<!-- QR OVERLAY -->
<div id="qr-overlay"
     style="position:fixed;inset:0;background:rgba(2,8,16,0.92);display:none;align-items:center;justify-content:center;z-index:200">
  <div id="qr-reader" style="width:360px;max-width:92%;border-radius:14px;overflow:hidden"></div>
  <button class="btn-ghost" id="qr-close" style="margin-top:14px">Close</button>
</div>

<!-- PRAYER MODAL -->
<div id="prayer-modal"
     style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,12,0.65);z-index:250;padding:14px">
  <div style="background:white;color:#031025;padding:20px;border-radius:14px;max-width:750px;max-height:80vh;overflow:auto">
    <h3 style="font-family:Times New Roman,serif;font-style:italic">Aunt Ida’s Prayer</h3>
    <div style="font-family:Times New Roman,serif;font-style:italic;line-height:1.5;margin-top:10px">
      Father, whose life is within me, and whose love is ever about me...
      <p style="margin-top:12px">...(full prayer here)...</p>
    </div>
    <div style="text-align:right;margin-top:10px">
      <button class="link-btn" id="closePrayerBtn">Close</button>
    </div>
  </div>
</div>

<div id="toast"></div>


<!-- =================================================================== -->
<!-- ======================   JAVASCRIPT START   ======================== -->
<!-- =================================================================== -->
<script type="module">

/* CONFIG --------------------------------------------------------------- */
const API_BASE = "https://iria-stall-passport-backend.onrender.com";
const DEFAULT_STALL_COUNT = 47;
 const STALL_MAP = {
  1: "Samsung",
  2: "Philips Healthcare",
  3: "Fujifilm",
  4: "United Imaging",
  6: "Cook Medical",
  7: "Esaote India",
  8: "Bard",
  9: "Sequoia Healthcare",
  10: "Vivere Imaging",
  11: "Siemens Healthineers",
  14: "GE Healthcare",
  15: "Carestream",
  16: "5C Network",
  17: "Hologic",
  18: "3i Medtech",
  19: "Sanrad Medical Systems",
  22: "Stradus",
  23: "Mindray",
  25: "Allengers",
  26: "Erbis Canon",
  27: "Guerbet",
  28: "Everrtech",
  29: "Sonoscape",
  31: "BET Medical P Ltd",
  32: "Bayer",
  33: "Teleflex/ITPL",
  34: "JB Chemicals",
  35: "Terumo",
  36: "Agfa",
  37: "Chisom",
  38: "CBS",
  39: "Meditek Agencies",
  40: "Prognosys Medical Systems",
  41: "Lifestyle Medicine",
  42: "Delhi Sweets",
  43: "Karigiri",
  44: "Ambur Leather",
  45: "Appu Silks, Arani",
  46: "Rehab / Just Beads",
  47: "Jawathu Hills Co-op",
  // add / edit freely later
};

/* ELEMENTS ------------------------------------------------------------- */
const authCard = document.getElementById("auth-card");
const gridCard = document.getElementById("grid-card");
const gridEl = document.getElementById("grid");
const leaderEl = document.getElementById("leader-list");
const toastEl = document.getElementById("toast");
const userBanner = document.getElementById("user-banner");
const heroTitle = document.querySelector(".hero-title");

/* INPUTS */
const nameInput = document.getElementById("name-input");
const emailInput = document.getElementById("email-input");
const passInput = document.getElementById("password-input");

const registerBtn = document.getElementById("registerBtn");
const loginBtn = document.getElementById("loginBtn");
const forgotBtn = document.getElementById("forgotBtn");
const logoutBtn = document.getElementById("logoutBtn");
const refreshLeaderboardBtn = document.getElementById("refreshLeaderboardBtn");
if (logoutBtn) {
  logoutBtn.onclick = () => {
  const ok = confirm(
    "Logging out will clear your passport from this device.\n\nDo you want to continue?"
  );

  if (!ok) return;

  localStorage.clear();
  location.reload();
};
}

/* QR */
const qrOverlay = document.getElementById("qr-overlay");
const qrReaderEl = document.getElementById("qr-reader");


/* STATE --------------------------------------------------------------- */
let jwtToken = localStorage.getItem("jwt") || null;
let currentName = localStorage.getItem("name") || null;


/* TOAST --------------------------------------------------------------- */
function showToast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 2200);
}


/* API WRAPPER --------------------------------------------------------- */
async function apiFetch(path, opts = {}){
  const headers = opts.headers || {};
  headers["Content-Type"] = "application/json";
  if(jwtToken) headers["Authorization"] = "Bearer " + jwtToken;
  opts.headers = headers;

  const res = await fetch(API_BASE + path, opts);
  const text = await res.text();
  let data;
  try { data = text ? JSON.parse(text) : null; }
  catch { data = text; }

  if(!res.ok) throw (data || {error:"Request failed"});
  return data;
}


/* AUTH ---------------------------------------------------------------- */
async function doRegister(){
  const name = nameInput.value.trim();
  const email = emailInput.value.trim();
  const pass = passInput.value.trim();

  if(!name || !email || !pass){
    alert("All fields — Name, Email, and Password — are required.");
    return;
  }

  try{
    const payload = { name, email, password: pass };
    const data = await apiFetch("/api/signup", {
      method:"POST",
      body:JSON.stringify(payload)
    });

    jwtToken = data.token;
    currentName = data.name;

    localStorage.setItem("jwt", jwtToken);
    localStorage.setItem("name", currentName);

    showToast("Registered & signed in");
updateUI();
updateAdminUI();
buildGrid(DEFAULT_STALL_COUNT);
await loadEverything();

  }catch(e){
    alert(e.error || e.message || "Registration error");
  }
}

async function doLogin(){
  const email = emailInput.value.trim();
  const pass = passInput.value.trim();

  if(!email || !pass){
    alert("Enter email & password.");
    return;
  }

  try{
    const data = await apiFetch("/api/login", {
      method:"POST",
      body:JSON.stringify({ email, password:pass })
    });

    jwtToken = data.token;
    currentName = data.name;

    localStorage.setItem("jwt", jwtToken);
    localStorage.setItem("name", currentName);

    showToast("Logged in");
    updateUI();
   updateAdminUI();
   buildGrid(DEFAULT_STALL_COUNT);
    await loadEverything();
  }catch(e){
    alert(e.error || e.message || "Login error");
  }
}

function doLogout(){
  jwtToken = null;
  currentName = null;
  localStorage.clear();
  updateUI();
  showToast("Logged out");
}


/* UI STATE ------------------------------------------------------------ */
function updateUI(){
  const loggedIn = Boolean(jwtToken && currentName);

  if (loggedIn) {
    authCard.classList.add("hidden");
    gridCard.classList.remove("hidden");
    userBanner.classList.remove("hidden");
    userBanner.textContent = `Welcome, ${currentName}`;

    document.getElementById("leaderboard").classList.remove("hidden");

    // Build grid ONLY once, AFTER login
    if (!gridEl.hasChildNodes()) {
      buildGrid(DEFAULT_STALL_COUNT);
    }

updateAdminUI();
   
  } else {
    authCard.classList.remove("hidden");
    gridCard.classList.add("hidden");
    userBanner.classList.add("hidden");
    document.getElementById("leaderboard").classList.add("hidden");

    // Remove grid completely when logged out
    gridEl.innerHTML = "";
  }
}


/* STALL GRID ---------------------------------------------------------- */
function buildGrid(n = DEFAULT_STALL_COUNT){
  gridEl.innerHTML = "";
  for(let i=1;i<=n;i++){
    const stall = document.createElement("div");
    stall.className = "neon-stall";
    stall.dataset.id = i;
    stall.innerHTML = STALL_MAP[i] || `Stall ${i}`;
    stall.onclick = ()=>openScanner(i);
    gridEl.appendChild(stall);
  }
}

function markVisited(id){
  document.querySelectorAll(".neon-stall").forEach(el=>{
    if(Number(el.dataset.id) === Number(id)){
      el.classList.add("visited");
      el.textContent = `Stall ${id} ✓`;
    }
  });
}


/* LOAD VISITS + LEADERBOARD ------------------------------------------ */
async function loadVisits(){
  if(!jwtToken) return;
  try{
    const data = await apiFetch(`/api/visits`);
    const visited = new Set(data.visits || []);
    visited.forEach(id => markVisited(id));
  }catch(e){
    console.warn(e);
  }
}

async function loadLeaderboard(){
  leaderEl.innerHTML = "Loading…";
  try{
    const data = await apiFetch("/api/leaderboard");
    leaderEl.innerHTML = "";
    (data.top || []).forEach((p,i)=>{
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.padding = "6px 4px";
      row.innerHTML =
        `<div>${i+1}. ${p.name}</div><div>${p.count} stalls</div>`;
      leaderEl.appendChild(row);
    });
  }catch(e){
    leaderEl.textContent = "Error loading leaderboard";
  }
}

async function loadEverything(){
  await loadVisits();
  await loadLeaderboard();
}


/* QR SCANNING --------------------------------------------------------- */
let qrScanner = null;

async function openScanner(stall){
  if(!jwtToken){ alert("Please login first."); return; }

  qrOverlay.style.display = "flex";

  if(!qrScanner){
    qrScanner = new Html5Qrcode("qr-reader");
  } else {
    try { await qrScanner.stop(); } catch {}
  }

  await qrScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    async (decoded)=>{
      try{ await qrScanner.stop(); }catch{}
      qrOverlay.style.display = "none";
      handleQR(decoded, stall);
    }
  );
}

async function handleQR(decoded, stallClicked){
  // Parse QR text: expected format IRIA2025|<number>
const parts = decoded.split("|");
const stall = Number(parts[1]) || stallClicked;

  // Hybrid flow (static QR)
  try{
    const tokenResp = await apiFetch("/api/generate-visit-token", {
      method:"POST",
      body:JSON.stringify({ stall })
    });

    const verify = await apiFetch("/api/verify", {
      method:"POST",
      body:JSON.stringify({
        stall,
        token: tokenResp.token,
        exp: tokenResp.exp
      })
    });

    if(verify.ok){
      showToast(`Recorded visit: Stall ${stall}`);
      markVisited(stall);
      await loadLeaderboard();
    } else {
      alert(verify.error || "Verification failed");
    }
  }catch(e){
    alert(e.error || "QR verification error");
  }
}

document.getElementById("qr-close").onclick = async ()=>{
  qrOverlay.style.display = "none";
  if(qrScanner){
    try{ await qrScanner.stop(); }catch{}
  }
};


/* HERO TITLE FADE ON SCROLL ------------------------------------------- */
window.addEventListener("scroll", ()=>{
  const fadeStart = 50;
  const fadeEnd = 260;

  const y = window.scrollY;
  if(y < fadeStart){
    heroTitle.style.opacity = "1";
    heroTitle.style.transform = "translateX(-50%) translateY(0)";
  } else if(y > fadeEnd){
    heroTitle.style.opacity = "0";
    heroTitle.style.transform = "translateX(-50%) translateY(-20px)";
  } else {
    const t = 1 - (y - fadeStart) / (fadeEnd - fadeStart);
    heroTitle.style.opacity = t;
    heroTitle.style.transform = `translateX(-50%) translateY(${-(20*(1-t))}px)`;
  }
});


/* GLASS FADE-IN -------------------------------------------------------- */
const verseGlass = document.getElementById("verseGlass");
const idaGlass = document.getElementById("idaGlass");

function revealGlass(){
  verseGlass.classList.add("revealed");
  setTimeout(()=> idaGlass.classList.add("revealed"), 200);
}

const glassZone = document.getElementById("glass-zone");
new IntersectionObserver((entries)=>{
  entries.forEach(e=>{ if(e.isIntersecting) revealGlass(); });
},{threshold:0.3}).observe(glassZone);


/* MISC UI --------------------------------------------------------------- */
document.getElementById("scrollToPassport").onclick =
  ()=> document.getElementById("passport").scrollIntoView({behavior:"smooth"});

/* Ida’s Prayer inline expand */
const togglePrayerBtn = document.getElementById("togglePrayerBtn");
const idaFull = document.getElementById("idaFull");

togglePrayerBtn.onclick = () => {
  const isOpen = idaFull.classList.toggle("open");
  togglePrayerBtn.textContent =
    isOpen ? "Hide Prayer" : "Read Full Prayer";
};

/* AUTH BUTTON HOOKS */
registerBtn.onclick = doRegister;
loginBtn.onclick = doLogin;
forgotBtn.onclick = ()=> alert("Ask registration desk to reset password.");
if(logoutBtn) logoutBtn.onclick = doLogout;

refreshLeaderboardBtn.onclick =
  ()=> loadLeaderboard().then(()=>showToast("Leaderboard refreshed"));

 /* ADMIN CSV DOWNLOAD */
const downloadCsvBtn = document.getElementById("downloadCsvBtn");

function getEmailFromJWT() {
  try {
    const token = localStorage.getItem("jwt");
    if (!token) return null;
    const payload = JSON.parse(atob(token.split(".")[1]));
    return payload.email;
  } catch {
    return null;
  }
}

if (downloadCsvBtn) {
  downloadCsvBtn.onclick = async () => {
    const res = await fetch(API_BASE + "/api/admin/export", {
      headers: {
        Authorization: "Bearer " + localStorage.getItem("jwt")
      }
    });

    const csv = await res.text();
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "iria_stall_passport.csv";
    a.click();
  };
}

/* INIT ----------------------------------------------------------------- */
updateUI();

if (jwtToken && currentName) {
  loadEverything();
}
 
</script>

</body>
</html>
